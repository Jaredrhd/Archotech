{"version":3,"sources":["../src/quickenrolment.js"],"names":["define","Template","$","Str","Config","Notification","ModalFactory","ModalEvents","Fragment","SELECTORS","COHORTSELECT","TRIGGERBUTTONS","UNWANTEDHIDDENFIELDS","QuickEnrolment","options","contextid","initModal","prototype","courseid","modal","triggerButtons","when","get_strings","key","component","create","type","types","SAVE_CANCEL","large","then","strings","setTitle","setSaveButtonText","getRoot","on","save","submitForm","bind","submitFormAjax","hidden","setBody","shown","bodyPromise","getBody","html","stringIndex","find","length","fail","exception","e","preventDefault","submit","form","each","remove","formData","serialize","hide","script","wwwroot","ajax","processData","contentType","response","error","addNotification","message","window","M","core_formchangechecker","reset_form_dirty_state","location","reload","loadFragment","getFooter","render","init","config"],"mappings":"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","sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Quick enrolment AMD module.\n *\n * @module     enrol_manual/quickenrolment\n * @copyright  2016 Damyon Wiese <damyon@moodle.com>\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\ndefine(['core/templates',\n         'jquery',\n         'core/str',\n         'core/config',\n         'core/notification',\n         'core/modal_factory',\n         'core/modal_events',\n         'core/fragment',\n       ],\n       function(Template, $, Str, Config, Notification, ModalFactory, ModalEvents, Fragment) {\n\n    /** @type {Object} The list of selectors for the quick enrolment modal. */\n    var SELECTORS = {\n        COHORTSELECT: \"#id_cohortlist\",\n        TRIGGERBUTTONS: \".enrolusersbutton.enrol_manual_plugin [type='submit']\",\n        UNWANTEDHIDDENFIELDS: \":input[value='_qf__force_multiselect_submission']\"\n    };\n\n    /**\n     * Constructor\n     *\n     * @param {Object} options Object containing options. The only valid option at this time is contextid.\n     * Each call to templates.render gets it's own instance of this class.\n     */\n    var QuickEnrolment = function(options) {\n        this.contextid = options.contextid;\n\n        this.initModal();\n    };\n    // Class variables and functions.\n\n    /** @var {number} courseid - */\n    QuickEnrolment.prototype.courseid = 0;\n\n    /** @var {Modal} modal */\n    QuickEnrolment.prototype.modal = null;\n\n    /**\n     * Private method\n     *\n     * @method initModal\n     * @private\n     */\n    QuickEnrolment.prototype.initModal = function() {\n        var triggerButtons = $(SELECTORS.TRIGGERBUTTONS);\n\n        $.when(\n            Str.get_strings([\n                {key: 'enroluserscohorts', component: 'enrol_manual'},\n                {key: 'enrolusers', component: 'enrol_manual'},\n            ]),\n            ModalFactory.create({\n                type: ModalFactory.types.SAVE_CANCEL,\n                large: true,\n            }, triggerButtons)\n        )\n        .then(function(strings, modal) {\n            this.modal = modal;\n\n            modal.setTitle(strings[1]);\n            modal.setSaveButtonText(strings[1]);\n\n            modal.getRoot().on(ModalEvents.save, this.submitForm.bind(this));\n            modal.getRoot().on('submit', 'form', this.submitFormAjax.bind(this));\n\n            // We want the reset the form every time it is opened.\n            modal.getRoot().on(ModalEvents.hidden, function() {\n                modal.setBody('');\n            });\n\n            modal.getRoot().on(ModalEvents.shown, function() {\n                var bodyPromise = this.getBody();\n                bodyPromise.then(function(html) {\n                    var stringIndex = $(html).find(SELECTORS.COHORTSELECT).length ? 0 : 1;\n                    modal.setSaveButtonText(strings[stringIndex]);\n\n                    return;\n                })\n                .fail(Notification.exception);\n\n                modal.setBody(bodyPromise);\n            }.bind(this));\n\n            return;\n        }.bind(this))\n        .fail(Notification.exception);\n    };\n\n    /**\n     * This triggers a form submission, so that any mform elements can do final tricks before the form submission is processed.\n     *\n     * @method submitForm\n     * @param {Event} e Form submission event.\n     * @private\n     */\n    QuickEnrolment.prototype.submitForm = function(e) {\n        e.preventDefault();\n        this.modal.getRoot().find('form').submit();\n    };\n\n    /**\n     * Private method\n     *\n     * @method submitForm\n     * @private\n     * @param {Event} e Form submission event.\n     */\n    QuickEnrolment.prototype.submitFormAjax = function(e) {\n        // We don't want to do a real form submission.\n        e.preventDefault();\n\n        var form = this.modal.getRoot().find('form');\n\n        // Before send the data through AJAX, we need to parse and remove some unwanted hidden fields.\n        // This hidden fields are added automatically by mforms and when it reaches the AJAX we get an error.\n        var hidden = form.find(SELECTORS.UNWANTEDHIDDENFIELDS);\n        hidden.each(function() {\n            $(this).remove();\n        });\n\n        var formData = form.serialize();\n\n        this.modal.hide();\n\n        var settings = {\n            type: 'GET',\n            processData: false,\n            contentType: \"application/json\"\n        };\n\n        var script = Config.wwwroot + '/enrol/manual/ajax.php?' + formData;\n        $.ajax(script, settings)\n            .then(function(response) {\n\n                if (response.error) {\n                    Notification.addNotification({\n                        message: response.error,\n                        type: \"error\"\n                    });\n                } else {\n                    // Reload the page, don't show changed data warnings.\n                    if (typeof window.M.core_formchangechecker !== \"undefined\") {\n                        window.M.core_formchangechecker.reset_form_dirty_state();\n                    }\n                    window.location.reload();\n                }\n                return;\n            })\n            .fail(Notification.exception);\n    };\n\n    /**\n     * Private method\n     *\n     * @method getBody\n     * @private\n     * @return {Promise}\n     */\n    QuickEnrolment.prototype.getBody = function() {\n        return Fragment.loadFragment('enrol_manual', 'enrol_users_form', this.contextid, {}).fail(Notification.exception);\n    };\n\n    /**\n     * Private method\n     *\n     * @method getFooter\n     * @private\n     * @return {Promise}\n     */\n    QuickEnrolment.prototype.getFooter = function() {\n        return Template.render('enrol_manual/enrol_modal_footer', {});\n    };\n\n    return /** @alias module:enrol_manual/quickenrolment */ {\n        // Public variables and functions.\n        /**\n         * Every call to init creates a new instance of the class with it's own event listeners etc.\n         *\n         * @method init\n         * @public\n         * @param {object} config - config variables for the module.\n         */\n        init: function(config) {\n            (new QuickEnrolment(config));\n        }\n    };\n});\n"],"file":"quickenrolment.min.js"}