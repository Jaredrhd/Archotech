define(["jquery","core/url","core/templates","core/notification","core/str","core/ajax","tool_lp/dragdrop-reorder","tool_lp/tree","tool_lp/dialogue","tool_lp/menubar","tool_lp/competencypicker","tool_lp/competency_outcomes","tool_lp/competencyruleconfig","core/pending"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n){var o,p,q,r,s,t,u=null,v=null,w=null,x=null,y=function(){var c=a('[data-region="competencyactions"]').data("competency"),f={competencyframeworkid:u.getCompetencyFrameworkId(),pagecontextid:o};null!==c&&(f.parentid=c.id);var g=function(){var c=a.param(f);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+c)};null!==c&&u.hasRule(c.id)?e.get_strings([{key:"confirm",component:"moodle"},{key:"addingcompetencywillresetparentrule",component:"tool_lp",param:c.shortname},{key:"yes",component:"core"},{key:"no",component:"core"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],g)}).fail(d.exception):g()},z=function(){var b=a('[data-region="filtercompetencies"]').data("frameworkid"),c=f.call([{methodname:"core_competency_set_parent_competency",args:{competencyid:v,parentid:w}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(F).fail(d.exception)},A=function(){if(w="undefined"==typeof w?0:w,w!=v){var a=u.getCompetency(w)||{},b=u.getCompetency(v)||{},c="movecompetencywillresetrules",f=!1;b.parentid!=w&&(a.path&&a.path.indexOf("/"+b.id+"/")>=0&&(c="movecompetencytochildofselfwillresetrules",f=f||u.hasRule(b.id)),f=f||u.hasRule(a.id)||u.hasRule(b.parentid),f?e.get_strings([{key:"confirm",component:"moodle"},{key:c,component:"tool_lp"},{key:"yes",component:"moodle"},{key:"no",component:"moodle"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],z)}).fail(d.exception):z())}},B=function(b){var c=a(b.getContent()),d=c.find("[data-enhance=movetree]"),e=new h(d,(!1));e.on("selectionchanged",function(b,c){var d=c.selected;w=a(d).data("id")}),d.show(),c.on("click",'[data-action="move"]',function(){b.close(),A()}),c.on("click",'[data-action="cancel"]',function(){b.close()})},C=function(a,b){var c;for(c=0;c<b.length;c++)b[c].parentid==a.id&&(a.haschildren=!0,b[c].children=[],b[c].haschildren=!1,a.children[a.children.length]=b[c],C(b[c],b))},D=function(b){b.preventDefault();var g=a('[data-region="competencyactions"]').data("competency");v=g.id;var h=f.call([{methodname:"core_competency_search_competencies",args:{competencyframeworkid:g.competencyframeworkid,searchtext:""}},{methodname:"core_competency_read_competency_framework",args:{id:g.competencyframeworkid}}]);a.when.apply(null,h).done(function(a,b){var f,h=[];for(f=0;f<a.length;f++){var j=a[f];"0"==j.parentid&&(j.children=[],j.haschildren=0,h[h.length]=j,C(j,a))}e.get_strings([{key:"movecompetency",component:"tool_lp",param:g.shortname},{key:"move",component:"tool_lp"},{key:"cancel",component:"moodle"}]).done(function(a){var e={framework:b,competencies:h};c.render("tool_lp/competencies_move_tree",e).done(function(b){new i(a[0],b,B)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},E=function(){var c=a('[data-region="competencyactions"]').data("competency"),d={competencyframeworkid:u.getCompetencyFrameworkId(),id:c.id,parentid:c.parentid,pagecontextid:o},e=a.param(d);window.location=b.relativeUrl("/admin/tool/lp/editcompetency.php?"+e)},F=function(b){c.render("tool_lp/manage_competencies_page",b).done(function(b,d){a('[data-region="managecompetencies"]').replaceWith(b),c.runTemplateJS(d)}).fail(d.exception)},G=function(b){b.preventDefault();var c=a('[data-region="filtercompetencies"]').data("frameworkid"),e=f.call([{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:c,search:a('[data-region="filtercompetencies"] input').val()}}]);e[0].done(F).fail(d.exception)},H=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"core_competency_move_up_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(F).fail(d.exception)},I=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"core_competency_move_down_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[1].done(F).fail(d.exception)},J=function(){var b=a('[data-region="competencyactions"]').data("competency"),g=f.call([{methodname:"tool_lp_list_courses_using_competency",args:{id:b.id}}]);g[0].done(function(a){var b={courses:a};c.render("tool_lp/linked_courses_summary",b).done(function(a){e.get_string("linkedcourses","tool_lp").done(function(b){new i(b,a,B)}).fail(d.exception)}).fail(d.exception)}).fail(d.exception)},K=function(){r=a('[data-region="competencyactions"]').data("competency"),p||(p=new k(o,r.competencyframeworkid),p.on("save",function(b,e){var g=new n,h=e.competencyIds,i=[];a.each(h,function(a,b){i.push({methodname:"core_competency_add_related_competency",args:{competencyid:b,relatedcompetencyid:r.id}})}),i.push({methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:r.id}});var j=f.call(i);j[i.length-1].then(function(a){return c.render("tool_lp/related_competencies",a)}).then(function(b,d){a('[data-region="relatedcompetencies"]').replaceWith(b),c.runTemplateJS(d),V()}).then(g.resolve)["catch"](d.exception)})),p.setDisallowedCompetencyIDs([r.id]),p.display()},L=function(b){b.preventDefault(),r=a('[data-region="competencyactions"]').data("competency"),q.setTargetCompetencyId(r.id),q.display()},M=function(a,b){var c={id:r.id,shortname:r.shortname,idnumber:r.idnumber,description:r.description,descriptionformat:r.descriptionformat,ruletype:b.ruletype,ruleoutcome:b.ruleoutcome,ruleconfig:b.ruleconfig},e=f.call([{methodname:"core_competency_update_competency",args:{competency:c}}]);e[0].then(function(a){a&&(r.ruletype=b.ruletype,r.ruleoutcome=b.ruleoutcome,r.ruleconfig=b.ruleconfig,Y(r))})["catch"](d.exception)},N=function(){var b=a('[data-region="competencyactions"]').data("competency"),c=f.call([{methodname:"core_competency_delete_competency",args:{id:b.id}},{methodname:"tool_lp_data_for_competencies_manage_page",args:{competencyframeworkid:b.competencyframeworkid,search:a('[data-region="filtercompetencies"] input').val()}}]);c[0].done(function(a){a===!1&&e.get_strings([{key:"competencycannotbedeleted",component:"tool_lp",param:b.shortname},{key:"cancel",component:"moodle"}]).done(function(a){d.alert(null,a[0])}).fail(d.exception)}).fail(d.exception),c[1].done(F).fail(d.exception)},O=function(){var b=a('[data-region="competencyactions"]').data("competency"),c="deletecompetency";u.hasRule(b.parentid)&&(c="deletecompetencyparenthasrule"),e.get_strings([{key:"confirm",component:"moodle"},{key:c,component:"tool_lp",param:b.shortname},{key:"delete",component:"moodle"},{key:"cancel",component:"moodle"}]).done(function(a){d.confirm(a[0],a[1],a[2],a[3],N)}).fail(d.exception)},P=function(b){b.originalEvent.dataTransfer.setData("text",a(b.target).parent().data("id"))},Q=function(a){a.originalEvent.dataTransfer.dropEffect="move",a.preventDefault()},R=function(b){b.preventDefault(),a(this).addClass("currentdragtarget")},S=function(b){b.preventDefault(),a(this).removeClass("currentdragtarget")},T=function(b){b.preventDefault(),v=b.originalEvent.dataTransfer.getData("text"),w=a(b.target).parent().data("id"),a(this).removeClass("currentdragtarget"),A()},U=function(b){b.preventDefault();var e=this.id.substr(11),g=a('[data-region="competencyactions"]').data("competency"),h=f.call([{methodname:"core_competency_remove_related_competency",args:{relatedcompetencyid:e,competencyid:g.id}},{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:g.id}}]);h[1].done(function(b){c.render("tool_lp/related_competencies",b).done(function(b){a('[data-region="relatedcompetencies"]').replaceWith(b),V()}).fail(d.exception)}).fail(d.exception)},V=function(){a('[data-action="deleterelation"]').on("click",U)},W=function(a){a.id!==x&&(x=a.id,f.call([{methodname:"core_competency_competency_viewed",args:{id:a.id}}]))},X=function(a){var b=s[a];return b||(b="competency"),b},Y=function(e){var g=a.Deferred().resolve().promise(),h={};h.competency=e,h.showdeleterelatedaction=!0,h.showrelatedcompetencies=!0,h.showrule=!1,h.pluginbaseurl=b.relativeUrl("/admin/tool/lp"),e.ruleoutcome!=l.NONE&&(g=l.getString(e.ruleoutcome).then(function(b){var c;return a.each(t,function(a,b){b.type==e.ruletype&&(c=b.name)}),[b,c]})),g.then(function(a){return"undefined"!=typeof a&&(h.showrule=!0,h.rule={outcome:a[0],type:a[1]}),h}).then(function(a){return c.render("tool_lp/competency_summary",a)}).then(function(b){return a('[data-region="competencyinfo"]').html(b),a('[data-action="deleterelation"]').on("click",U),c.render("tool_lp/loading",{})}).then(function(a,b){return c.replaceNodeContents('[data-region="relatedcompetencies"]',a,b),f.call([{methodname:"tool_lp_data_for_related_competencies_section",args:{competencyid:e.id}}])[0]}).then(function(a){return c.render("tool_lp/related_competencies",a)}).then(function(b,d){a('[data-region="relatedcompetencies"]').replaceWith(b),c.runTemplateJS(d),V()})["catch"](d.exception)},Z=function(a){return e.get_string("taxonomy_add_"+X(a),"tool_lp")},$=function(a){return e.get_string("taxonomy_selected_"+X(a),"tool_lp")},_=function(b,c){var e=c.selected,f=a(e).data("id"),g=a('[data-region="competencyactions"] [data-action="add"]'),h=a('[data-region="competencyactionsmenu"]'),i=a('[data-region="selected-competency"]'),k=0,l=1;if(j.closeAll(),"undefined"==typeof f)a('[data-region="competencyinfo"]').html(e.clone().children().remove().end().text()),a('[data-region="competencyactions"]').data("competency",null),h.hide();else{var m=u.getCompetency(f);k=u.getCompetencyLevel(f),l=k+1,h.show(),a('[data-region="competencyactions"]').data("competency",m),Y(m),W(m)}return $(k).then(function(a){i.text(a)})["catch"](d.exception),Z(l).then(function(a){g.show().find('[data-region="term"]').text(a)})["catch"](d.exception),b.preventDefault(),!1},aa=function(a){var b=a.split(",");return b.unshift(""),delete b[0],b};return{init:function(b,c,d,e){u=b,o=c,s=aa(d),t=e,a('[data-region="competencyactions"] [data-action="add"]').on("click",y),j.enhance(".competencyactionsmenu",{'[data-action="edit"]':E,'[data-action="delete"]':O,'[data-action="move"]':D,'[data-action="moveup"]':H,'[data-action="movedown"]':I,'[data-action="linkedcourses"]':J,'[data-action="relatedcompetencies"]':K.bind(this),'[data-action="competencyrules"]':L.bind(this)}),a('[data-region="competencyactionsmenu"]').hide(),a('[data-region="competencyactions"] [data-action="add"]').hide(),a('[data-region="filtercompetencies"]').on("submit",G);var f=a('[data-region="managecompetencies"] [data-enhance="tree"]');f.on("dragstart","li>span",P).on("dragover","li>span",Q).on("dragenter","li>span",R).on("dragleave","li>span",S).on("drop","li>span",T),b.on("selectionchanged",_),q=new m(u,t),q.on("save",M.bind(this))}}});